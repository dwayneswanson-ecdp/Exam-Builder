<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="google" content="notranslate" />
<title>Exam Builder – Instructor Portal</title>
<style>
  :root { --blue:#004080; --blue2:#0066cc; --bg:#f6f8fb; --card:#ffffff; --border:#d8dee9; }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); margin:0; color:#1b1f23;}
  header{background:linear-gradient(135deg,var(--blue),var(--blue2)); color:#fff; padding:28px 18px; text-align:center;}
  header h1{margin:0; font-weight:800; letter-spacing:.3px}
  main{max-width:1000px; margin:28px auto; padding:0 16px 40px}
  .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:22px 20px; box-shadow:0 2px 10px rgba(0,0,0,.04); margin-bottom:18px;}
  h2{margin:8px 0 12px; color:var(--blue); font-size:20px}
  label{display:block; font-size:14px; margin-top:10px; color:#0f172a}
  input[type=text], input[type=number], textarea{width:100%; border:1px solid var(--border); border-radius:8px; padding:10px 12px; font-size:15px; background:#fff;}
  textarea{min-height:110px; resize:vertical}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
  .row-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px}
  .small{font-size:12px; color:#6b7280}
  .btn{background:var(--blue); color:#fff; border:none; padding:12px 18px; border-radius:10px; font-size:16px; cursor:pointer}
  .btn:hover{background:#003166}
  table{width:100%; border-collapse:collapse; margin-top:8px}
  th, td{border:1px solid var(--border); padding:8px; font-size:14px}
  th{background:#eef2ff; text-align:left}
  .gate{max-width:440px; margin:60px auto}
  .muted{color:#64748b; font-size:13px}
  .err{color:#b00020; font-size:13px; margin-left:10px; display:none}
  .footer{color:#6b7280; font-size:13px; margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>Exam Builder – Instructor Portal</h1>
</header>

<main>
  <!-- Password Gate (visible on load) -->
  <section class="card gate" id="gate">
    <h2>Instructor Access</h2>
    <label>Password
      <input type="password" id="gatePwd" placeholder="Enter password…" />
    </label>
    <div style="margin-top:12px">
      <button class="btn" id="gateBtn">Unlock</button>
      <span id="gateErr" class="err">Incorrect password.</span>
      <div class="muted" style="margin-top:8px">You can change the password in this file.</div>
    </div>
  </section>

  <!-- Builder UI (hidden until unlock) -->
  <section id="builder" style="display:none">
    <div class="card">
      <h2>Step 1 — Exam Info</h2>
      <div class="row">
        <label>Exam Title
          <input type="text" id="examTitle" value="English Exam – Business Resources" />
        </label>
        <label>Class Code
          <input type="text" id="classCode" value="MDO2G3" />
        </label>
      </div>
      <div class="row">
        <label>Time Limit (minutes)
          <input type="number" id="timeLimit" min="5" max="180" step="5" value="40" />
        </label>
        <label>Email Subject Format <span class="small">(use <b>(NAME)</b> placeholder)</span>
          <input type="text" id="emailSubject" value="(NAME) – English Exam – Business Resources (MDO2G3)" />
        </label>
      </div>
    </div>

    <div class="card">
      <h2>Step 2 — Email Delivery (EmailJS)</h2>
      <div class="row">
        <label>Public Key
          <input type="text" id="emailjsKey" placeholder="e.g., Bb0oPYBiZGQcyIz5r" />
        </label>
        <label>Service ID
          <input type="text" id="emailjsService" placeholder="e.g., service_opm4h6b" />
        </label>
      </div>
      <div class="row">
        <label>Template ID
          <input type="text" id="emailjsTemplate" placeholder="e.g., template_r0u784p" />
        </label>
        <label>Instructor Email (note)
          <input type="text" id="instructorEmail" placeholder="Destination is configured in your EmailJS template" />
        </label>
      </div>
      <p class="small">Your EmailJS template should include variables <code>{{subject}}</code> and <code>{{message_html}}</code>.</p>
    </div>

    <div class="card">
      <h2>Step 3 — Vocabulary (10 items)</h2>
      <p class="small">Enter the <b>Word</b> and its <b>Correct Definition</b>. Students will match via dropdowns (randomized; “-- Choose --” is always first).</p>
      <table>
        <thead><tr><th>#</th><th>Word</th><th>Correct Definition</th></tr></thead>
        <tbody id="vocabBody"></tbody>
      </table>
      <div class="footer">Defaults are prefilled; edit freely.</div>
    </div>

    <div class="card">
      <h2>Step 4 — Part B Writing Prompt</h2>
      <label>Prompt Text
        <textarea id="promptText">You are a team leader. One of your suppliers has delayed an important delivery. Write a short email to your manager. In your email, explain the problem, suggest a solution, and use a polite and professional tone. You must use at least 3 words from the vocabulary list.</textarea>
      </label>
    </div>

    <div class="card">
      <h2>Step 5 — Generate Exam</h2>
      <button class="btn" id="generateBtn">Generate & Download index.html</button>
      <p class="small">This downloads a self-contained student exam (timer, fullscreen guard, anti-copy, EmailJS reporting).</p>
    </div>
  </section>
</main>

<script>
/* ======= Password Gate ======= */
const BUILDER_PASSWORD = "teacher2025";
document.getElementById("gateBtn").addEventListener("click", () => {
  const ok = document.getElementById("gatePwd").value === BUILDER_PASSWORD;
  document.getElementById("gateErr").style.display = ok ? "none" : "inline";
  if (ok) { document.getElementById("gate").style.display="none"; document.getElementById("builder").style.display="block"; }
});

/* ======= Prefill Vocab Rows ======= */
const defaults = [
  ["Budget","A plan for how money will be spent during a specific period."],
  ["Forecast","A prediction of future sales, costs, or results."],
  ["KPI","A measurable value showing how effectively goals are achieved."],
  ["Supplier","A company providing goods or services to another."],
  ["Lead Time","The time between ordering and receiving something."],
  ["Inventory","The goods and materials a company holds."],
  ["Overhead","Ongoing expenses not tied to one product or service."],
  ["Sustainability","Managing resources for long-term balance."],
  ["ROI","Financial gain or loss compared to cost of investment."],
  ["Headcount","Number of employees in a company or department."]
];
const tbody = document.getElementById("vocabBody");
for (let i=0;i<10;i++){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${i+1}</td>
    <td><input type="text" id="w${i}" value="${defaults[i][0]}"></td>
    <td><input type="text" id="d${i}" value="${defaults[i][1]}"></td>`;
  tbody.appendChild(tr);
}

/* ======= Build Student Exam HTML (string only; not rendered here) ======= */
function buildExamHTML(cfg){
  const esc = s => String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  const defs = cfg.vocab.map(v=>v.definition);
  const selectFor = (n) => `
    <select name="q${n+1}">
      <option value="">-- Choose --</option>
      ${defs.map(d=>`<option>${esc(d)}</option>`).join("")}
    </select>`;
  const corrPairs = cfg.vocab.map((v,i)=>`q${i+1}: "${esc(v.definition)}"`).join(",\n    ");
  const wordNames = cfg.vocab.map(v=>`"${esc(v.word)}"`).join(",");
  const olItems = cfg.vocab.map((v,i)=>`<li>${esc(v.word)} ${selectFor(i)}</li>`).join("");

  return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="google" content="notranslate" />
<title>${esc(cfg.title)}</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f8f9fb;margin:0;color:#222;font-size:16px;line-height:1.6;}
  header{background:linear-gradient(135deg,#004080,#0066cc);color:#ffffff;padding:25px 20px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
  header h1{color:#ffffff;font-size:1.9em;margin:0;letter-spacing:.4px;}
  #timer{text-align:right;font-weight:bold;color:#ffffff;margin-top:10px;}
  main{max-width:860px;margin:40px auto;background:#fff;padding:40px;border-radius:12px;box-shadow:0 0 12px rgba(0,0,0,0.1);}
  section{margin-bottom:40px;border-bottom:1px solid #ddd;padding-bottom:30px;}
  #login{background:#ffffff;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.08);padding:30px;max-width:520px;margin:30px auto;}
  select,textarea,input{width:100%;padding:10px;margin-top:6px;margin-bottom:14px;border:1px solid #ccc;border-radius:6px;}
  button{background:#004080;color:#fff;border:none;padding:12px 28px;border-radius:6px;cursor:pointer;font-size:16px;}
  button:hover{background:#003366;}
  ol li{margin-bottom:16px;}
  .tbl{border-collapse:collapse;width:100%;font-size:15px;margin-top:10px}
  .tbl th,.tbl td{border:1px solid #ccc;padding:8px}
  .tbl thead th{background:#004080;color:#fff;text-align:left}
</style>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  emailjs.init("${esc(cfg.emailjsKey||"")}");
  const login = document.getElementById("login");
  const exam  = document.getElementById("exam");
  const timerDisplay = document.getElementById("timer");
  const form  = document.getElementById("examForm");
  let timeLeft = ${Number(cfg.timeLimit)} * 60, timerInt;

  const correctAnswers = { ${corrPairs} };

  // Randomize dropdowns; keep "-- Choose --" first
  document.querySelectorAll("select").forEach(sel=>{
    const first = sel.options[0];
    const rest  = Array.from(sel.options).slice(1);
    for(let i=rest.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [rest[i].text,rest[j].text] = [rest[j].text,rest[i].text];
    }
    sel.innerHTML = ""; sel.appendChild(first); rest.forEach(o=>sel.appendChild(o)); sel.selectedIndex = 0;
  });

  function startTimer(){
    timerInt = setInterval(()=>{
      timeLeft--;
      const m=Math.floor(timeLeft/60), s=timeLeft%60;
      timerDisplay.textContent = \`Time Remaining: \${m}:\${s.toString().padStart(2,"0")}\`;
      if(timeLeft<=0){ clearInterval(timerInt); submitExam(); }
    },1000);
  }

  function terminateExam(){
    const f = document.getElementById("examForm");
    f.reset(); Array.from(f.elements).forEach(el=>el.disabled=true);
    const overlay=document.createElement("div");
    overlay.innerHTML=\`<div style="position:fixed;inset:0;background:rgba(0,0,0,.9);color:#fff;display:flex;align-items:center;justify-content:center;z-index:9999;text-align:center;padding:20px;"><div><h2>⚠️ Exam Terminated</h2><p>You exited full screen. Inputs erased for security.</p></div></div>\`;
    document.body.appendChild(overlay); setTimeout(()=>location.reload(),8000);
  }

  function enableFullScreen(){
    document.documentElement.requestFullscreen?.().catch(()=>{});
    document.addEventListener("fullscreenchange", ()=>{ if(!document.fullscreenElement){ terminateExam(); } });
  }

  // Anti copy/paste & shortcuts
  ["copy","cut","paste","contextmenu"].forEach(evt=>document.addEventListener(evt, e=>e.preventDefault()));
  document.addEventListener("keydown", e=>{
    if((e.ctrlKey||e.metaKey)&&["c","v","x","u","a"].includes(e.key.toLowerCase())) e.preventDefault();
    if(e.key==="F12"||e.key==="Escape") e.preventDefault();
  });

  document.getElementById("startBtn").onclick = () => {
    const name=document.getElementById("studentName").value.trim();
    const email=document.getElementById("studentEmail").value.trim();
    const code=document.getElementById("classCode").value.trim();
    if(!name||!email){ alert("Please enter your name and email."); return; }
    if(code !== "${esc(cfg.classCode)}"){ alert("Invalid class code."); return; }
    document.getElementById("studentNameField").value = name;
    document.getElementById("studentEmailField").value = email;
    document.getElementById("classCodeField").value = code;
    login.style.display="none"; exam.style.display="block"; enableFullScreen(); startTimer();
  };

  form.addEventListener("submit", e=>{ e.preventDefault(); submitExam(); });

  function submitExam(){
    clearInterval(timerInt);
    const fd=new FormData(form);
    const name = fd.get("studentName") || document.getElementById("studentNameField").value;
    const email= fd.get("studentEmail") || document.getElementById("studentEmailField").value;
    const minutesUsed = ${Number(cfg.timeLimit)} - Math.floor(timeLeft/60);

    const answers=[]; let score=0;
    for(let i=1;i<=10;i++){
      const sel = fd.get("q"+i) || "No answer";
      const corr= correctAnswers["q"+i];
      const ok  = (sel===corr);
      if(ok) score++;
      answers.push({ sel, corr, ok });
    }
    const wordNames=[${wordNames}];
    const partARows = answers.map((a,idx)=>\`
      <tr>
        <td style="padding:8px;border:1px solid #ccc;">\${wordNames[idx]}</td>
        <td style="padding:8px;border:1px solid #ccc;">\${a.sel}</td>
        <td style="padding:8px;border:1px solid #ccc;color:\${a.ok?'green':'#b00'};">
          \${a.ok ? '✅ Correct' : '❌ Incorrect → Correct answer: '+a.corr}
        </td>
      </tr>\`).join("");

    const htmlReport = \`
      <h2 style="color:#004080;">${esc(cfg.title)} – \${name} (${esc(cfg.classCode)})</h2>
      <p><b>Student Name:</b> \${name}<br><b>Student Email:</b> \${email}<br><b>Class Code:</b> ${esc(cfg.classCode)}<br><b>Time Taken:</b> \${minutesUsed} min</p>
      <hr>
      <h3 style="color:#004080;">Part A – Vocabulary Matching</h3>
      <table class="tbl">
        <thead><tr><th>Word</th><th>Student Answer</th><th>Result</th></tr></thead>
        <tbody>\${partARows}</tbody>
      </table>
      <p><b>Part A Score:</b> \${score}/10</p>
      <hr>
      <h3 style="color:#004080;">Part B – Email Writing & Instructor Feedback</h3>
      <p><b>Student’s Response:</b></p>
      <div style="border:1px solid #ccc;border-radius:6px;padding:10px;margin-bottom:15px;background:#f9f9f9;">
        \${(fd.get("emailBody")||"").replace(/\\n/g,"<br>")}
      </div>
      <table class="tbl">
        <thead><tr><th>Criterion</th><th>Maximum Score</th><th>Score Awarded</th></tr></thead>
        <tbody>
          <tr><td>Vocabulary Use</td><td>/3</td><td>___ / 3</td></tr>
          <tr><td>Structure & Clarity</td><td>/3</td><td>___ / 3</td></tr>
          <tr><td>Language Accuracy & Tone</td><td>/2</td><td>___ / 2</td></tr>
          <tr><td>Professional Style</td><td>/2</td><td>___ / 2</td></tr>
        </tbody>
      </table>
      <br>
      <p><b>Instructor Comments:</b></p>
      <p style="border:1px solid #ccc;padding:10px;border-radius:6px;min-height:50px;">[Type feedback here]</p>
      <h4 style="color:#004080;">Score Summary</h4>
      <table class="tbl" style="max-width:460px;">
        <tr><td>Part A Score</td><td>\${score} / 10</td></tr>
        <tr><td>Part B Score</td><td>___ / 10</td></tr>
        <tr><td><b>Final Note</b></td><td><b>___ / 20</b></td></tr>
      </table>
      <div style="border-top:1px solid #ccc;margin-top:20px;padding-top:10px;font-size:13px;">
        <em>This report was generated automatically for ${esc(cfg.title)}.</em>
      </div>\`;

    const subject = \`${cfg.subject}\`.replace("(NAME)", name);

    emailjs.send("${esc(cfg.emailjsService||"")}", "${esc(cfg.emailjsTemplate||"")}", {
      from_name: name,
      from_email: email,
      subject: subject,
      message_html: htmlReport
    })
    .then(()=>{ alert("✅ Exam submitted successfully. You may close this window."); document.getElementById("exam").style.display="none"; })
    .catch(err=>{ alert("❌ Error sending exam: " + (err?.text||"")); console.error("EmailJS Error:", err); });
  }
});
</script>
</head>
<body>
<header>
  <h1>${esc(cfg.title)} (${esc(cfg.classCode)})</h1>
  <div id="timer"></div>
</header>
<main>
  <section id="login">
    <h2>Start Exam</h2>
    <p>Enter your details to begin. Once started, you will have <b>${Number(cfg.timeLimit)} minutes</b>.</p>
    <label>Name:<input type="text" id="studentName" required></label>
    <label>Email:<input type="email" id="studentEmail" required></label>
    <label>Class Code:<input type="text" id="classCode" required></label>
    <button id="startBtn">Start Exam</button>
  </section>
  <section id="exam" style="display:none;">
    <form id="examForm">
      <input type="hidden" name="studentName" id="studentNameField">
      <input type="hidden" name="studentEmail" id="studentEmailField">
      <input type="hidden" name="classCode" id="classCodeField">
      <h2>Part A – Vocabulary Matching</h2>
      <ol>${olItems}</ol>
      <h2>Part B – Email Writing Task</h2>
      <p>${esc(cfg.prompt)}</p>
      <textarea name="emailBody" required></textarea>
      <button type="submit">Submit Exam</button>
    </form>
  </section>
</main>
</body>
</html>`;
}

/* ======= Generate & Auto-Download ======= */
document.getElementById("generateBtn").addEventListener("click", () => {
  const title      = (document.getElementById("examTitle").value || "English Exam").trim();
  const classCode  = (document.getElementById("classCode").value || "CLASS").trim();
  const timeLimit  = Math.max(5, +document.getElementById("timeLimit").value || 40);
  const emailSub   = (document.getElementById("emailSubject").value || "(NAME) – English Exam").trim();
  const emailjsKey = document.getElementById("emailjsKey").value.trim();
  const emailjsService = document.getElementById("emailjsService").value.trim();
  const emailjsTemplate= document.getElementById("emailjsTemplate").value.trim();

  const vocab = [];
  for(let i=0;i<10;i++){
    const w = (document.getElementById("w"+i).value || "").trim();
    const d = (document.getElementById("d"+i).value || "").trim();
    if(!w || !d){ alert("Please fill all vocabulary rows (word + definition)."); return; }
    vocab.push({word:w, definition:d});
  }
  const prompt = (document.getElementById("promptText").value || "").trim();
  if(!prompt){ alert("Please enter a Part B prompt."); return; }

  const html = buildExamHTML({
    title, classCode, timeLimit,
    subject: emailSub,
    emailjsKey, emailjsService, emailjsTemplate,
    vocab, prompt
  });

  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `English_Exam_${classCode}.html`;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
});
</script>
</body>
</html>
